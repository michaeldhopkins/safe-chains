use crate::handlers;

pub struct CommandDoc {
    pub name: &'static str,
    pub kind: DocKind,
    pub description: &'static str,
}

pub enum DocKind {
    AlwaysSafe,
    Handler,
}

pub fn all_command_docs() -> Vec<CommandDoc> {
    let mut docs = safe_cmd_docs();
    docs.extend(handlers::handler_docs());
    docs.sort_by_key(|d| d.name);
    docs
}

pub fn render_markdown(docs: &[CommandDoc]) -> String {
    let mut out = String::from(
        "# Supported Commands\n\
         \n\
         Auto-generated by `safe-chains --list-commands`.\n\
         \n\
         Any command with only `--version` or `--help` as its sole argument is always allowed.\n\
         \n\
         ## Unconditionally Safe\n\
         \n\
         These commands are allowed with any arguments.\n\
         \n\
         | Command | Description |\n\
         |---------|-------------|\n",
    );

    for doc in docs.iter().filter(|d| matches!(d.kind, DocKind::AlwaysSafe)) {
        out.push_str(&format!("| `{}` | {} |\n", doc.name, doc.description));
    }

    out.push_str("\n## Handled Commands\n\nThese commands are allowed with specific subcommands or flags.\n\n");

    for doc in docs.iter().filter(|d| matches!(d.kind, DocKind::Handler)) {
        out.push_str(&format!("### `{}`\n\n{}\n\n", doc.name, doc.description));
    }

    out
}

fn safe_cmd_docs() -> Vec<CommandDoc> {
    let mut docs: Vec<CommandDoc> = handlers::SAFE_CMDS
        .iter()
        .map(|&name| CommandDoc {
            name,
            kind: DocKind::AlwaysSafe,
            description: safe_cmd_description(name),
        })
        .collect();
    docs.sort_by_key(|d| d.name);
    docs
}

fn safe_cmd_description(name: &str) -> &'static str {
    match name {
        "arch" => "Print machine architecture",
        "b2sum" => "BLAKE2 checksum",
        "base64" => "Base64 encode/decode",
        "basename" => "Strip directory from path",
        "bc" => "Calculator",
        "branchdiff" => "Branch diff tool",
        "cal" => "Display calendar",
        "cat" => "Print file contents",
        "cd" => "Change directory",
        "cksum" => "File checksum",
        "cloc" => "Count lines of code",
        "colordiff" => "Colorized diff",
        "column" => "Format into columns",
        "comm" => "Compare sorted files",
        "command" => "Run command or check existence",
        "cucumber" => "BDD test runner",
        "cut" => "Extract fields from lines",
        "date" => "Display date and time",
        "df" => "Disk free space",
        "diff" => "Compare files",
        "dig" => "DNS lookup",
        "dirname" => "Strip filename from path",
        "du" => "Disk usage",
        "echo" => "Print text",
        "expand" => "Convert tabs to spaces",
        "expr" => "Evaluate expression",
        "factor" => "Print prime factors",
        "false" => "Return failure exit code",
        "fd" => "Find files",
        "file" => "Detect file type",
        "fmt" => "Reformat text",
        "fold" => "Wrap lines",
        "getconf" => "Get system configuration values",
        "grep" => "Search file contents",
        "groups" => "Print group memberships",
        "head" => "Print first lines",
        "hexdump" => "Display file in hex",
        "host" => "DNS lookup",
        "hostname" => "Print hostname",
        "iconv" => "Convert character encoding",
        "id" => "Print user/group IDs",
        "identify" => "ImageMagick identify",
        "jq" => "JSON processor",
        "locale" => "Print locale info",
        "lsof" => "List open files",
        "ls" => "List directory",
        "md5" => "MD5 checksum (macOS)",
        "md5sum" => "MD5 checksum",
        "mdfind" => "Spotlight search (macOS)",
        "mdls" => "File metadata (macOS)",
        "nl" => "Number lines",
        "nm" => "List object file symbols",
        "nproc" => "Print number of CPUs",
        "nslookup" => "DNS lookup",
        "od" => "Octal dump",
        "otool" => "Object file tool (macOS)",
        "paste" => "Merge lines of files",
        "pgrep" => "Search for processes",
        "printenv" => "Print environment variables",
        "printf" => "Format and print text",
        "ps" => "List processes",
        "pwd" => "Print working directory",
        "readlink" => "Resolve symlink",
        "realpath" => "Resolve path",
        "rev" => "Reverse lines",
        "rg" => "Ripgrep search",
        "seq" => "Print number sequence",
        "sha1sum" => "SHA-1 checksum",
        "sha256sum" => "SHA-256 checksum",
        "sha512sum" => "SHA-512 checksum",
        "shasum" => "SHA checksum",
        "shellcheck" => "Shell script linter",
        "size" => "Object file section sizes",
        "sleep" => "Pause execution",
        "stat" => "File status",
        "strings" => "Find printable strings in binary",
        "sum" => "File checksum",
        "sw_vers" => "macOS version info",
        "tac" => "Print file in reverse",
        "tail" => "Print last lines",
        "test" => "Evaluate conditional expression",
        "tokei" => "Code statistics",
        "tr" => "Translate characters",
        "tree" => "Directory tree",
        "true" => "Return success exit code",
        "tty" => "Print terminal name",
        "unexpand" => "Convert spaces to tabs",
        "uniq" => "Filter duplicate lines",
        "uname" => "System information",
        "uptime" => "System uptime",
        "uuidgen" => "Generate UUID",
        "wc" => "Count lines/words/bytes",
        "which" => "Locate command",
        "whois" => "Domain registration lookup",
        "whoami" => "Print current user",
        "xxd" => "Hex dump",
        _ => "Safe read-only utility",
    }
}
