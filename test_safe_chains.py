#!/usr/bin/env python3
import json
import os
import subprocess
import sys

SCRIPT = os.path.join(os.path.dirname(os.path.abspath(__file__)), "safe-chains.sh")

ALLOW = True
DENY = False


def check(command, expected):
    input_data = json.dumps({"tool_input": {"command": command}})
    result = subprocess.run(
        ["python3", SCRIPT],
        input=input_data,
        capture_output=True,
        text=True,
    )
    got_allow = '"permissionDecision": "allow"' in result.stdout
    return got_allow == expected


TESTS = {
    "SAFE_CMDS": [
        ("grep foo file.txt", ALLOW),
        ("cat /etc/hosts", ALLOW),
        ("jq '.key' file.json", ALLOW),
        ("base64 -d", ALLOW),
        ("xxd some/file", ALLOW),
        ("pgrep -l ruby", ALLOW),
        ("getconf PAGE_SIZE", ALLOW),
        ("ls -la", ALLOW),
        ("wc -l file.txt", ALLOW),
        ("env", ALLOW),
        ("env rm -rf /", DENY),
        ("env sh -c 'rm -rf /'", DENY),
        ("env python3 evil.py", DENY),
        ("awk '{print $1}' file.txt", DENY),
        ("awk 'BEGIN{system(\"rm\")}'", DENY),
        ("ps aux", ALLOW),
        ("ps -ef", ALLOW),
        ("uuidgen", ALLOW),
        ("mdfind 'kMDItemKind == Application'", ALLOW),
        ("identify image.png", ALLOW),
        ("identify -verbose photo.jpg", ALLOW),
        ("rm -rf /", DENY),
        ("curl https://example.com", DENY),
        ("ruby script.rb", DENY),
        ("python3 script.py", DENY),
        ("node app.js", DENY),
        ("tee output.txt", DENY),
        ("tee -a logfile", DENY),
    ],
    "find handler": [
        ("find . -name '*.rb'", ALLOW),
        ("find . -type f -name '*.py'", ALLOW),
        ("find /tmp -maxdepth 2", ALLOW),
        ("find . -name '*.log' -print", ALLOW),
        ("find . -name '*.log' -print0", ALLOW),
        ("find . -name '*.tmp' -delete", DENY),
        ("find . -exec rm {} \\;", DENY),
        ("find . -execdir cat {} \\;", DENY),
        ("find . -ok rm {} \\;", DENY),
        ("find . -okdir rm {} \\;", DENY),
        ("find . -name '*.py' -exec grep pattern {} +", DENY),
        ("find . -type f -name '*.bak' -delete", DENY),
        ("find . -fprint /tmp/list.txt", DENY),
        ("find . -fprint0 /tmp/list.txt", DENY),
        ("find . -fls /tmp/list.txt", DENY),
        ("find . -fprintf /tmp/list.txt '%p'", DENY),
    ],
    "sed handler": [
        ("sed 's/foo/bar/'", ALLOW),
        ("sed -n 's/foo/bar/p'", ALLOW),
        ("sed -e 's/foo/bar/' -e 's/baz/qux/'", ALLOW),
        ("sed -E 's/[0-9]+/NUM/g'", ALLOW),
        ("sed -i 's/foo/bar/' file.txt", DENY),
        ("sed --in-place 's/foo/bar/' file.txt", DENY),
        ("sed -i.bak 's/foo/bar/' file.txt", DENY),
        ("sed -ni 's/foo/bar/p' file.txt", DENY),
        ("sed -in 's/foo/bar/' file.txt", DENY),
        ("sed --in-place=.bak 's/foo/bar/' file.txt", DENY),
    ],
    "sort handler": [
        ("sort file.txt", ALLOW),
        ("sort -r file.txt", ALLOW),
        ("sort -n -u file.txt", ALLOW),
        ("sort -t: -k2 /etc/passwd", ALLOW),
        ("sort -o output.txt file.txt", DENY),
        ("sort --output=result.txt file.txt", DENY),
        ("sort --output result.txt file.txt", DENY),
        ("sort -rno sorted.txt file.txt", DENY),
    ],
    "unsafe shell syntax": [
        ("echo hello > file.txt", DENY),
        ("cat file >> output.txt", DENY),
        ("ls 2> errors.txt", DENY),
        ("grep pattern file > results.txt", DENY),
        ("find . -name '*.py' > listing.txt", DENY),
        ("echo 'greater > than' test", ALLOW),
        ("git log < /dev/null", DENY),
        ("echo $(rm -rf /)", DENY),
        ("echo `rm -rf /`", DENY),
        ("cat $(echo /etc/shadow)", DENY),
        ("ls `pwd`", DENY),
        ("echo '$(safe)' arg", ALLOW),
        ("echo hello", ALLOW),
        ("cat file.txt", ALLOW),
        ("grep pattern file", ALLOW),
    ],
    "background operator": [
        ("cat file & rm -rf /", DENY),
        ("echo safe & curl evil.com", DENY),
        ("ls & echo done", ALLOW),
        ("ls && echo done", ALLOW),
    ],
    "newline separator": [
        ("echo foo\nrm -rf /", DENY),
        ("ls\ncurl evil.com", DENY),
        ("echo foo\necho bar", ALLOW),
        ("ls\ncat file.txt", ALLOW),
    ],
    "pipes and chains": [
        ("grep foo file.txt | head -5", ALLOW),
        ("cat file | sort | uniq", ALLOW),
        ("find . -name '*.rb' | wc -l", ALLOW),
        ("cat file | rm -rf /", DENY),
        ("grep foo | curl https://evil.com", DENY),
        ("ls && echo done", ALLOW),
        ("ls; echo done", ALLOW),
        ("git log | head -5", ALLOW),
        ("git log && git status", ALLOW),
    ],
    "sh/bash -c": [
        ('bash -c "grep foo file"', ALLOW),
        ('bash -c "cat file | head -5"', ALLOW),
        ('bash -c "rm file"', DENY),
        ('sh -c "ls -la"', ALLOW),
        ('sh -c "curl https://evil.com"', DENY),
        ("bash script.sh", DENY),
    ],
    "xargs": [
        ("xargs grep pattern", ALLOW),
        ("xargs cat", ALLOW),
        ("xargs ls", ALLOW),
        ("xargs -I {} cat {}", ALLOW),
        ("xargs rm", DENY),
        ("xargs curl", DENY),
        ("xargs -0 grep foo", ALLOW),
        ("xargs npx @herb-tools/linter", ALLOW),
        ("xargs npx cowsay", DENY),
        ("xargs find . -name '*.py'", ALLOW),
        ("xargs sed 's/foo/bar/'", ALLOW),
        ("xargs sed -i 's/foo/bar/'", DENY),
        ("xargs find . -delete", DENY),
        ("xargs sort -o out.txt", DENY),
    ],
    "--version": [
        ("node --version", ALLOW),
        ("python --version", ALLOW),
        ("python3 --version", ALLOW),
        ("ruby --version", ALLOW),
        ("rustc --version", ALLOW),
        ("java --version", ALLOW),
        ("go --version", ALLOW),
        ("php --version", ALLOW),
        ("perl --version", ALLOW),
        ("swift --version", ALLOW),
        ("gcc --version", ALLOW),
        ("node --version --extra", DENY),
        ("node -v", DENY),
        ("rm --version", ALLOW),
        ("dd --version", ALLOW),
        ("chmod --version", ALLOW),
    ],
    "gh": [
        ("gh pr view 123", ALLOW),
        ("gh pr list", ALLOW),
        ("gh pr diff 123", ALLOW),
        ("gh pr checks 123", ALLOW),
        ("gh issue view 456", ALLOW),
        ("gh issue list", ALLOW),
        ("gh run view 789", ALLOW),
        ("gh release list", ALLOW),
        ("gh api repos/o/r/pulls/1", ALLOW),
        ("gh api repos/o/r/contents/f --jq '.content'", ALLOW),
        ("gh api repos/o/r/pulls -X GET", ALLOW),
        ("gh api repos/o/r/pulls --paginate", ALLOW),
        ("gh pr create --title test", DENY),
        ("gh pr merge 123", DENY),
        ("gh api repos/o/r/pulls/1 -X PATCH -f body=x", DENY),
        ("gh api repos/o/r/pulls/1 -X POST", DENY),
        ("gh api repos/o/r/issues -f title=x", DENY),
        ("gh api repos/o/r/pulls/1 --method=PATCH", DENY),
        ("gh api repos/o/r/pulls -XPOST", DENY),
        ("gh api repos/o/r/pulls -XPATCH", DENY),
        ("gh api repos/o/r/pulls -XGET", ALLOW),
        ("gh auth login", DENY),
        ("gh", DENY),
    ],
    "git": [
        ("git log --oneline -5", ALLOW),
        ("git diff --stat", ALLOW),
        ("git show HEAD:some/file.rb", ALLOW),
        ("git status --porcelain", ALLOW),
        ("git fetch origin master", ALLOW),
        ("git ls-tree HEAD", ALLOW),
        ("git grep pattern", ALLOW),
        ("git rev-parse HEAD", ALLOW),
        ("git merge-base master HEAD", ALLOW),
        ("git merge-tree HEAD~1 HEAD master", ALLOW),
        ("git --version", ALLOW),
        ("git help log", ALLOW),
        ("git shortlog -s", ALLOW),
        ("git describe --tags", ALLOW),
        ("git blame file.rb", ALLOW),
        ("git reflog", ALLOW),
        ("git -C /some/repo diff --stat", ALLOW),
        ("git -C /some/repo -C nested log", ALLOW),
        ("git remote -v", ALLOW),
        ("git remote get-url origin", ALLOW),
        ("git remote show origin", ALLOW),
        ("git remote", ALLOW),
        ("git push origin main", DENY),
        ("git reset --hard HEAD~1", DENY),
        ("git add .", DENY),
        ("git commit -m 'test'", DENY),
        ("git checkout -- file.rb", DENY),
        ("git rebase origin/master", DENY),
        ("git stash", DENY),
        ("git branch -D feature", DENY),
        ("git rm file.rb", DENY),
        ("git remote add upstream https://github.com/foo/bar", DENY),
        ("git remote remove upstream", DENY),
        ("git remote rename origin upstream", DENY),
        ("git -c user.name=foo log", DENY),
        ("git", DENY),
    ],
    "jj": [
        ("jj log", ALLOW),
        ("jj diff --stat", ALLOW),
        ("jj show abc123", ALLOW),
        ("jj status", ALLOW),
        ("jj st", ALLOW),
        ("jj help", ALLOW),
        ("jj --version", ALLOW),
        ("jj op log", ALLOW),
        ("jj file show some/path", ALLOW),
        ("jj config get user.name", ALLOW),
        ("jj new master", DENY),
        ("jj edit abc123", DENY),
        ("jj squash", DENY),
        ("jj describe -m 'test'", DENY),
        ("jj bookmark set my-branch", DENY),
        ("jj git push", DENY),
        ("jj git fetch", DENY),
        ("jj rebase -d master", DENY),
        ("jj restore file.rb", DENY),
        ("jj abandon", DENY),
        ("jj config set user.name foo", DENY),
        ("jj", DENY),
    ],
    "yarn": [
        ("yarn list --depth=0", ALLOW),
        ("yarn info react", ALLOW),
        ("yarn why lodash", ALLOW),
        ("yarn --version", ALLOW),
        ("yarn test", ALLOW),
        ("yarn test:watch", ALLOW),
        ("yarn test --testPathPattern=Foo", ALLOW),
        ("yarn install", DENY),
        ("yarn add react", DENY),
        ("yarn remove lodash", DENY),
        ("yarn upgrade", DENY),
    ],
    "npm": [
        ("npm view react version", ALLOW),
        ("npm info lodash", ALLOW),
        ("npm list --depth=0", ALLOW),
        ("npm ls", ALLOW),
        ("npm install react", DENY),
        ("npm uninstall lodash", DENY),
        ("npm run build", DENY),
        ("npm test", DENY),
    ],
    "self test": [
        ("python3 test_safe_chains.py", ALLOW),
        ("python test_safe_chains.py", ALLOW),
        ("python3 /some/path/test_safe_chains.py", ALLOW),
        ("python3 test_safe_chains.py --verbose", DENY),
        ("python3 script.py", DENY),
        ("python3 manage.py", DENY),
        ("python3 -c 'import os'", DENY),
        ("python3", DENY),
        ("python3 test_other.py", DENY),
    ],
    "pip": [
        ("pip list", ALLOW),
        ("pip show requests", ALLOW),
        ("pip freeze", ALLOW),
        ("pip check", ALLOW),
        ("pip3 list", ALLOW),
        ("pip3 show flask", ALLOW),
        ("pip3 freeze", ALLOW),
        ("pip install requests", DENY),
        ("pip uninstall flask", DENY),
        ("pip3 install django", DENY),
        ("pip", DENY),
    ],
    "bundle": [
        ("bundle list", ALLOW),
        ("bundle info rails", ALLOW),
        ("bundle show actionpack", ALLOW),
        ("bundle check", ALLOW),
        ("bundle exec rspec spec/models/foo_spec.rb", ALLOW),
        ("bundle exec standardrb app/models/foo.rb", ALLOW),
        ("bundle exec standardrb --fix app/models/foo.rb", ALLOW),
        ("bundle exec cucumber", ALLOW),
        ("bundle exec brakeman", ALLOW),
        ("bundle exec erb_lint app/views/foo.html.erb", ALLOW),
        ("bundle exec herb app/views/foo.html.erb", ALLOW),
        ("bundle install", DENY),
        ("bundle update", DENY),
        ("bundle exec rails console", DENY),
        ("bundle exec rake db:drop", DENY),
        ("bundle exec ruby script.rb", DENY),
    ],
    "mise": [
        ("mise ls", ALLOW),
        ("mise list ruby", ALLOW),
        ("mise current ruby", ALLOW),
        ("mise which ruby", ALLOW),
        ("mise doctor", ALLOW),
        ("mise --version", ALLOW),
        ("mise settings get experimental", ALLOW),
        ("mise install ruby@3.4", DENY),
        ("mise exec -- ruby foo.rb", DENY),
        ("mise use ruby@3.4", DENY),
    ],
    "asdf": [
        ("asdf current ruby", ALLOW),
        ("asdf which ruby", ALLOW),
        ("asdf help", ALLOW),
        ("asdf list ruby", ALLOW),
        ("asdf --version", ALLOW),
        ("asdf install ruby 3.4", DENY),
    ],
    "gem": [
        ("gem list", ALLOW),
        ("gem info rails", ALLOW),
        ("gem environment", ALLOW),
        ("gem which bundler", ALLOW),
        ("gem pristine --all", ALLOW),
        ("gem install rails", DENY),
        ("gem uninstall rails", DENY),
    ],
    "brew": [
        ("brew list", ALLOW),
        ("brew info node", ALLOW),
        ("brew --version", ALLOW),
        ("brew install node", DENY),
        ("brew uninstall node", DENY),
        ("brew services list", DENY),
    ],
    "cargo": [
        ("cargo clippy -- -D warnings", ALLOW),
        ("cargo test", ALLOW),
        ("cargo build --release", ALLOW),
        ("cargo check", ALLOW),
        ("cargo doc", ALLOW),
        ("cargo search serde", ALLOW),
        ("cargo --version", ALLOW),
        ("cargo bench", ALLOW),
        ("cargo install --path .", DENY),
        ("cargo run", DENY),
        ("cargo clean", DENY),
    ],
    "npx": [
        ("npx @herb-tools/linter app/views/foo.html.erb", ALLOW),
        ("npx eslint src/", ALLOW),
        ("npx karma start", ALLOW),
        ("npx --yes eslint src/", ALLOW),
        ("npx -y @herb-tools/linter .", ALLOW),
        ("npx --package @herb-tools/linter @herb-tools/linter .", ALLOW),
        ("npx -- eslint src/", ALLOW),
        ("npx react-scripts start", DENY),
        ("npx cowsay hello", DENY),
        ("npx", DENY),
        ("npx --yes", DENY),
    ],
    "timeout and time": [
        ("timeout 120 bundle exec rspec", ALLOW),
        ("timeout 30 git log --oneline", ALLOW),
        ("timeout -s KILL 60 bundle exec rspec", ALLOW),
        ("timeout --preserve-status 120 git status", ALLOW),
        ("timeout 120 git push origin main", DENY),
        ("timeout 60 rm -rf /", DENY),
        ("time bundle exec rspec", ALLOW),
        ("time git log --oneline -5", ALLOW),
        ("time git push", DENY),
        ("time rm file", DENY),
    ],
    "env prefix": [
        ("RACK_ENV=test bundle exec rspec spec/foo_spec.rb", ALLOW),
        ("RAILS_ENV=test bundle exec rspec", ALLOW),
        ("RACK_ENV=test rm -rf /", DENY),
        ("RAILS_ENV=test echo foo > bar", DENY),
    ],
    "compound pipelines": [
        ("git log --oneline -20 | head -5", ALLOW),
        ("git show HEAD:file.rb | grep pattern", ALLOW),
        ("gh api repos/o/r/contents/f --jq .content | base64 -d | head -50", ALLOW),
        ("timeout 120 bundle exec rspec && git status", ALLOW),
        ("time bundle exec rspec | tail -5", ALLOW),
        ("git -C /some/repo log --oneline | head -3", ALLOW),
        ("xxd file | head -20", ALLOW),
        ("find . -name '*.py' | wc -l", ALLOW),
        ("find . -name '*.py' | sort | head -10", ALLOW),
        ("find . -name '*.py' | xargs grep pattern", ALLOW),
        ("pip list | grep requests", ALLOW),
        ("npm list | grep react", ALLOW),
        ("ps aux | grep python", ALLOW),
        ("find . -name '*.py' -delete | wc -l", DENY),
        ("sed -i 's/foo/bar/' file | head", DENY),
    ],
}


def main():
    total = 0
    passed = 0
    failed = []

    for category, cases in TESTS.items():
        for command, expected in cases:
            total += 1
            if check(command, expected):
                passed += 1
            else:
                expected_str = "allow" if expected else "deny"
                got_str = "deny" if expected else "allow"
                failed.append((category, command, expected_str, got_str))

    if failed:
        print(f"\nFAILED ({len(failed)} of {total}):\n")
        for category, command, expected, got in failed:
            print(f"  [{category}] {command}")
            print(f"    expected {expected}, got {got}\n")
        sys.exit(1)
    else:
        print(f"All {total} tests passed.")
        sys.exit(0)


if __name__ == "__main__":
    main()
